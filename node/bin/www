#!/usr/bin/env node

/**
 * ç­”é¢˜ç³»ç»Ÿç»Ÿä¸€å¯åŠ¨æ–‡ä»¶
 * æ”¯æŒæœ¬åœ°å¼€å‘å’Œéƒ¨ç½²ç¯å¢ƒ
 * è‡ªåŠ¨æ ¹æ®ç¯å¢ƒå˜é‡é€‚é…ä¸åŒé…ç½®
 */

// åŠ è½½ç¯å¢ƒå˜é‡
require('dotenv').config();

// å¯¼å…¥å¢å¼ºç‰ˆæ•°æ®åº“ç®¡ç†å™¨
const { dbManager } = require('../db/db.enhanced.js');

// å¼€å‘ç¯å¢ƒæ£€æµ‹
const isDevelopment = process.env.NODE_ENV !== 'production';
const environment = process.env.NODE_ENV || 'development';

/**
 * å¼‚æ­¥å¯åŠ¨åº”ç”¨
 */
async function startApplication() {
  try {
    // æ˜¾ç¤ºå¯åŠ¨ä¿¡æ¯
    console.log('\n========================================');
    console.log('ğŸš€ ç­”é¢˜ç³»ç»Ÿæ­£åœ¨å¯åŠ¨...');
    console.log('========================================');
    console.log(`ç¯å¢ƒ: ${environment}`);
    console.log(`æ•°æ®åº“æä¾›å•†: ${process.env.MONGO_PROVIDER || 'æœ¬åœ°MongoDB'}`);
    console.log(`å¼€å‘æ¨¡å¼: ${isDevelopment ? 'å¼€å¯' : 'å…³é—­'}`);
    
    // è¿æ¥æ•°æ®åº“
    console.log('\nğŸ’¾ æ­£åœ¨è¿æ¥æ•°æ®åº“...');
    await dbManager.connect();
    console.log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ');

    // å¯¼å…¥åº”ç”¨æ¨¡å—
    const app = require('../app');
    const debug = require('debug')('project:server');
    const http = require('http');

    // è·å–ç«¯å£
    const port = normalizePort(process.env.PORT || '3000');
    app.set('port', port);

    // åˆ›å»º HTTP æœåŠ¡å™¨
    const server = http.createServer(app);

    // ç»‘å®šç«¯å£å’Œäº‹ä»¶ç›‘å¬
    server.listen(port);
    server.on('error', (error) => onError(error, port));
    server.on('listening', () => onListening(server, port));

    // è®¾ç½®ä¼˜é›…å…³é—­å¤„ç†
    setupGracefulShutdown(server);

  } catch (error) {
    console.error('\nâŒ åº”ç”¨å¯åŠ¨å¤±è´¥:', error.message);
    if (isDevelopment) {
      console.error(error.stack);
    }
    process.exit(1);
  }
}

/**
 * ç«¯å£è§„èŒƒåŒ–
 */
function normalizePort(val) {
  const port = parseInt(val, 10);

  if (isNaN(port)) {
    return val; // named pipe
  }

  if (port >= 0) {
    return port; // port number
  }

  return false;
}

/**
 * HTTP æœåŠ¡å™¨é”™è¯¯äº‹ä»¶å¤„ç†
 */
function onError(error, port) {
  if (error.syscall !== 'listen') {
    throw error;
  }

  const bind = typeof port === 'string'
    ? 'Pipe ' + port
    : 'Port ' + port;

  switch (error.code) {
    case 'EACCES':
      console.error(`\nâŒ ${bind} éœ€è¦ç®¡ç†å‘˜æƒé™`);
      process.exit(1);
      break;
    case 'EADDRINUSE':
      console.error(`\nâŒ ${bind} å·²è¢«å ç”¨`);
      process.exit(1);
      break;
    default:
      throw error;
  }
}

/**
 * HTTP æœåŠ¡å™¨ç›‘å¬äº‹ä»¶å¤„ç†
 */
function onListening(server, port) {
  const addr = server.address();
  const bind = typeof addr === 'string'
    ? 'pipe ' + addr
    : 'port ' + addr.port;
  
  console.log('\n========================================');
  console.log('âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼');
  console.log('========================================');
  console.log(`ğŸ“ ç›‘å¬åœ°å€: ${bind}`);
  console.log(`ğŸŒ è®¿é—®åœ°å€: http://localhost:${port}`);
  console.log(`ğŸ“Š å¥åº·æ£€æŸ¥: http://localhost:${port}/health`);
  console.log(`ğŸ’¾ æ•°æ®åº“çŠ¶æ€: ${dbManager.isHealthy() ? 'âœ… å¥åº·' : 'âŒ å¼‚å¸¸'}`);
  
  if (isDevelopment) {
    console.log(`ğŸ”§ å¼€å‘æ¨¡å¼: çƒ­é‡è½½å·²å¼€å¯`);
  }
  
  console.log('========================================\n');
  
  // debug è¾“å‡º
  const debug = require('debug')('project:server');
  debug('Listening on ' + bind);
}

/**
 * ä¼˜é›…å…³é—­å¤„ç†
 */
function setupGracefulShutdown(server) {
  const signals = ['SIGTERM', 'SIGINT'];
  
  signals.forEach((signal) => {
    process.on(signal, async () => {
      console.log(`\n\nğŸš¨ æ”¶åˆ° ${signal} ä¿¡å·ï¼Œæ­£åœ¨ä¼˜é›…å…³é—­...`);
      
      // åœæ­¢æ¥å—æ–°è¿æ¥
      server.close(async () => {
        console.log('âœ… HTTPæœåŠ¡å™¨å·²å…³é—­');
        
        // å…³é—­æ•°æ®åº“è¿æ¥
        try {
          await dbManager.disconnect();
          console.log('âœ… æ•°æ®åº“è¿æ¥å·²å…³é—­');
          console.log('ğŸ‘‹ å†è§ï¼');
          process.exit(0);
        } catch (error) {
          console.error('âŒ å…³é—­æ•°æ®åº“è¿æ¥æ—¶å‡ºé”™:', error.message);
          process.exit(1);
        }
      });
      
      // è®¾ç½®è¶…æ—¶å¼ºåˆ¶é€€å‡º
      setTimeout(() => {
        console.error('âš ï¸  è¶…æ—¶ï¼Œå¼ºåˆ¶é€€å‡ºåº”ç”¨');
        process.exit(1);
      }, 10000); // 10ç§’è¶…æ—¶
    });
  });
  
  // æ•è·æœªå¤„ç†çš„å¼‚å¸¸
  process.on('uncaughtException', (error) => {
    console.error('\nâŒ æœªæ•è·å¼‚å¸¸:', error.message);
    if (isDevelopment) {
      console.error(error.stack);
    }
    process.exit(1);
  });
  
  process.on('unhandledRejection', (reason, promise) => {
    console.error('\nâŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', reason);
    if (isDevelopment) {
      console.error('Promise:', promise);
    }
    process.exit(1);
  });
}

// å¯åŠ¨åº”ç”¨
startApplication();